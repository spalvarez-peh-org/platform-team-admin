version: 2.1

executors:
  local-machine:
    machine: true
    resource_class: peh_runner/local_laptop_runner
    working_directory: ~/project

jobs:
  pulumi-preview:
    executor: local-machine
    environment:
      PULUMI_STACK: dev
    steps:
      - checkout

      - run:
          name: Ensure Bitwarden is logged out
          command: |
            bw logout || echo "No active session"

      - run:
          name: Log into Bitwarden using API key
          command: |
            echo "Logging into Bitwarden..."
            bw login --apikey --quiet

      - run:
          name: Unlock Bitwarden Vault
          command: |
            export BW_SESSION=$(bw unlock --passwordenv BW_PASSWORD --raw)
            echo "export BW_SESSION=$BW_SESSION" >> $BASH_ENV

      - run:
          name: Load GitHub secrets from Bitwarden
          command: |
            source $BASH_ENV
            ITEM_JSON=$(bw get item "GitHub Secrets" --session "$BW_SESSION")

            export GITHUB_TOKEN=$(echo "$ITEM_JSON" | jq -r '.fields[] | select(.name=="pulumi-github-token") | .value')
            export GITHUB_OWNER=$(echo "$ITEM_JSON" | jq -r '.fields[] | select(.name=="pulumi-github-owner") | .value')

            echo "export GITHUB_TOKEN=$GITHUB_TOKEN" >> $BASH_ENV
            echo "export GITHUB_OWNER=$GITHUB_OWNER" >> $BASH_ENV

      - run:
          name: Set up Python virtual environment
          command: |
            python3 -m venv .venv
            source .venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

      - run:
          name: Select Pulumi stack and preview
          command: |
            source $BASH_ENV
            source .venv/bin/activate
            pulumi stack select "$PULUMI_STACK"
            pulumi preview
          
workflows:
  preview:
    jobs:
      - pulumi-preview:
          context: PLATFORM_ADMIN
