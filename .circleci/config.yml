version: 2.1

executors:
  local-kind:
    type: local

jobs:
  setup-kind-cluster:
    executor: local-kind
    steps:
      - checkout

      - run:
          name: Create Kind cluster
          command: |
            if ! kind get clusters | grep -q circleci-kind; then
              kind create cluster --name circleci-kind
            else
              echo "Kind cluster already exists"
            fi

      - run:
          name: Validate Kind cluster
          command: |
            kubectl cluster-info --context kind-circleci-kind
            kubectl get nodes

      - run:
          name: Run your tests
          command: |
            echo "Run tests here (kubectl apply, helm test, etc.)"

      - run:
          name: Delete Kind cluster
          when: always
          command: |
            kind delete cluster --name circleci-kind

workflows:
  test-with-kind:
    jobs:
      - setup-kind-cluster
