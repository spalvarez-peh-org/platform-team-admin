version: 2.1

orbs:
  pulumi: pulumi/pulumi@2.1.0
  python: circleci/python@3.1.0
executors:
  local-machine:
    machine: true
    resource_class: peh_runner/local_laptop_runner
    working_directory: ~/project

jobs:
  pulumi-preview:
    executor: local-machine
    environment:
      PULUMI_STACK: dev
    steps:
      - checkout

      # This step is only needed because we run locally
      - run:
          name: Wipe Bitwarden CLI config and sessions
          command: |
            echo "Cleaning up old Bitwarden CLI session"
            bw lock || echo "Vault already locked"
            bw logout || echo "No active session"
            rm -rf ~/Library/Application\ Support/Bitwarden\ CLI/
            export BW_SESSION=""

      - run:
          name: Log into Bitwarden using API key
          command: |
            echo "Logging into Bitwarden..."
            bw login --apikey
            
            echo "Unlock BW session"
            BW_SESSION=$(bw unlock ${BW_PASSWORD} --raw)

            echo "Get GitHub Secrets from Vault"
            ITEM_JSON=$(bw get item "GitHub Secrets" --session "$BW_SESSION")
            export GITHUB_TOKEN=$(echo "$ITEM_JSON" | jq -r '.fields[] | select(.name=="pulumi-github-token") | .value')
            export GITHUB_OWNER=$(echo "$ITEM_JSON" | jq -r '.fields[] | select(.name=="pulumi-github-owner") | .value')
            echo "export GITHUB_TOKEN=$GITHUB_TOKEN" >> $BASH_ENV
            echo "export GITHUB_OWNER=$GITHUB_OWNER" >> $BASH_ENV
            
      - pulumi/login

      - python/install-packages:
          pkg-manager: uv

      - run:
          name: Install packages
          command: |
            uv venv
            uv add -r requirements.txt
            source .venv/bin/activate

      - pulumi/preview:
          stack: "${PULUMI_STACK}"    
          
workflows:
  preview:
    jobs:
      - pulumi-preview:
          context: PLATFORM_ADMIN
