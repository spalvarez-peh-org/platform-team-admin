version: 2.1

executors:
  local-machine:
    machine: true
    resource_class: peh_runner/local_laptop_runner

jobs:
  setup-kind-cluster:
    executor: local-machine
    steps:
      - checkout

      - run:
          name: Create Kind cluster
          command: |
            echo "PATH is: $PATH"
            if ! kind get clusters | grep -q circleci-kind; then
              kind create cluster --name circleci-kind
            else
              echo "Kind cluster already exists"
            fi

      - run:
          name: Validate Kind cluster
          command: |
            kubectl cluster-info --context kind-circleci-kind
            kubectl get nodes

      # - run:
      #     name: Delete Kind cluster
      #     when: always
      #     command: |
      #       kind delete cluster --name circleci-kind

workflows:
  test-with-kind:
    jobs:
      - setup-kind-cluster
